name: LiveUser

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'å‘å¸ƒç±»å‹'
        required: true
        default: 'Beta'
        type: choice
        options:
          - Beta
          - Release

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: "1.23"
  BINARY_NAME: "liveuser"
  DOCKER_IMAGE: "liveuser"
  MODULE_NAME: "github.com/${{ github.repository }}"

jobs:
  lint:
    name: ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: éªŒè¯æ–‡ä»¶
        run: |
          required_files=("main.go" "main.js" "demo.html" "Dockerfile")
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ç¼ºå°‘æ–‡ä»¶: $file"
              exit 1
            fi
          done
          echo "âœ… é™æ€æ–‡ä»¶å°†å†…ç½®åˆ°äºŒè¿›åˆ¶ä¸­"

      - name: ä»£ç æ£€æŸ¥
        run: |
          if [ ! -f go.mod ]; then
            go mod init ${{ env.MODULE_NAME }}
          fi
          go get github.com/gorilla/websocket@latest
          go mod tidy
          go fmt ./...
          go vet ./...
          go build -o /tmp/test .
          rm -f /tmp/test

  version:
    name: ç‰ˆæœ¬å¤„ç†
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: lint
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¡ç®—ç‰ˆæœ¬å·
        id: version
        run: |
          echo "is_release=${{ github.event.inputs.release_type == 'Release' }}" >> $GITHUB_OUTPUT
          
          latest_tag=$(git tag -l "v*" --sort=-version:refname | head -n1 || echo "v0.0.0")
          
          if [[ $latest_tag =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            major=${BASH_REMATCH[1]}
            minor=${BASH_REMATCH[2]}
            patch=${BASH_REMATCH[3]}
          else
            major=0
            minor=0
            patch=0
          fi
          
          patch=$((patch + 1))
          new_version="v${major}.${minor}.${patch}"
          echo "version=$new_version" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºæ ‡ç­¾
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.version }}" -m "Release ${{ steps.version.outputs.version }}"
          git push origin "${{ steps.version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-and-release:
    name: æ„å»º
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: version
    strategy:
      matrix:
        include:
          - { os: linux, arch: amd64 }
          - { os: linux, arch: arm64 }
          - { os: darwin, arch: amd64 }
          - { os: darwin, arch: arm64 }
          - { os: windows, arch: amd64 }
          - { os: windows, arch: arm64 }
          - { os: freebsd, arch: amd64 }
          - { os: freebsd, arch: arm64 }
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: å‡†å¤‡ä¾èµ–
        run: |
          if [ ! -f go.mod ]; then
            go mod init ${{ env.MODULE_NAME }}
          fi
          go get github.com/gorilla/websocket@latest
          go mod tidy

      - name: æ„å»ºäºŒè¿›åˆ¶
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
          VERSION: ${{ needs.version.outputs.version }}
        run: |
          binary_name="${{ env.BINARY_NAME }}"
          if [ "${{ matrix.os }}" = "windows" ]; then
            binary_name="${binary_name}.exe"
          fi
          
          echo "ğŸ”¨ æ„å»º ${{ matrix.os }}/${{ matrix.arch }} å¹³å°"
          go build \
            -trimpath \
            -ldflags="-s -w -X main.Version=${VERSION}" \
            -o "${binary_name}" \
            .
          
          mkdir -p dist
          package_name="${{ env.BINARY_NAME }}-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}"
          
          # åªæ‰“åŒ…äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆé™æ€æ–‡ä»¶å·²å†…ç½®ï¼‰
          if [ "${{ matrix.os }}" = "windows" ]; then
            zip -9 "dist/${package_name}.zip" "${binary_name}"
            echo "âœ… å·²åˆ›å»º: ${package_name}.zip"
          else
            tar -czf "dist/${package_name}.tar.gz" "${binary_name}"
            echo "âœ… å·²åˆ›å»º: ${package_name}.tar.gz"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/
          retention-days: 1

  github-release:
    name: å‘å¸ƒ
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: [version, build-and-release]
    steps:
      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          path: artifacts
          merge-multiple: true

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          echo "ğŸ“¥ æ”¶é›†æ„å»ºäº§ç‰©"
          find artifacts -name "*.zip" -o -name "*.tar.gz" | while read file; do
            filename=$(basename "$file")
            cp "$file" "release/$filename"
            echo "âœ… å·²æ·»åŠ : $filename"
          done
          
          echo "ğŸ”’ ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ"
          cd release
          sha256sum *.zip *.tar.gz > checksums.txt 2>/dev/null || sha256sum * > checksums.txt
          
          echo "ğŸ“‹ å‘å¸ƒæ¸…å•:"
          ls -lh

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
        run: |
          echo "**SHA256:**" > release_notes.md
          echo '```' >> release_notes.md
          cat release/checksums.txt >> release_notes.md
          echo '```' >> release_notes.md

      - name: åˆ›å»º Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.version.outputs.version }}
          name: "${{ needs.version.outputs.version }}"
          bodyFile: release_notes.md
          artifacts: "release/*"
          draft: false
          prerelease: ${{ needs.version.outputs.is_release != 'true' }}
          generateReleaseNotes: false
          allowUpdates: true
          removeArtifacts: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: Docker æ„å»º
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: version
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ (Beta)
        if: ${{ needs.version.outputs.is_release != 'true' }}
        run: |
          echo "ğŸ³ æ„å»º Docker é•œåƒ (é¢„å‘å¸ƒç‰ˆ)"
          docker buildx build \
            --build-arg VERSION="${{ needs.version.outputs.version }}" \
            --platform linux/amd64,linux/arm64 \
            --tag "${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.version }}" \
            --tag "${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:beta" \
            --push \
            .
          echo "âœ… Docker é•œåƒæ¨é€å®Œæˆ"

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ (Release)
        if: ${{ needs.version.outputs.is_release == 'true' }}
        run: |
          echo "ğŸ³ æ„å»º Docker é•œåƒ (æ­£å¼ç‰ˆ)"
          docker buildx build \
            --build-arg VERSION="${{ needs.version.outputs.version }}" \
            --platform linux/amd64,linux/arm64 \
            --tag "${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ needs.version.outputs.version }}" \
            --tag "${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest" \
            --push \
            .
          echo "âœ… Docker é•œåƒæ¨é€å®Œæˆ"
