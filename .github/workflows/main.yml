name: LiveUser

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      release_type:
        description: '发布类型'
        required: true
        default: 'Beta'
        type: choice
        options:
          - Beta
          - Release

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: "1.23"
  BINARY_NAME: "LiveUser"
  MODULE_NAME: "github.com/${{ github.repository }}"
  DOCKER_IMAGE: "liveuser"
  PLATFORMS: "linux/amd64,linux/arm64"

################################################################################
# 代码检查 (所有情况都执行)
################################################################################
jobs:
  lint:
    name: 代码检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: 验证必需文件
        run: |
          required_files=("main.go" "main.js" "demo.html")
          missing_files=()
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "缺少必需文件:"
            printf '%s\n' "${missing_files[@]}"
            exit 1
          fi

      - name: 初始化模块
        run: |
          if [ ! -f go.mod ]; then
            go mod init ${{ env.MODULE_NAME }}
          fi
          
          go get github.com/gorilla/websocket@latest
          go mod tidy

      - name: 代码检查
        run: |
          go fmt ./...
          go vet ./...
          go build -o /tmp/test-build .
          rm -f /tmp/test-build

################################################################################
# 多平台构建 (仅手动触发时执行)
################################################################################
  build:
    name: 构建
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: lint
    strategy:
      matrix:
        include:
          - { os: linux, arch: amd64 }
          - { os: linux, arch: arm64 }
          - { os: darwin, arch: amd64 }
          - { os: darwin, arch: arm64 }
          - { os: windows, arch: amd64 }
          - { os: windows, arch: arm64 }
          - { os: freebsd, arch: amd64 }
          - { os: freebsd, arch: arm64 }
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Go 环境
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false

      - name: 准备依赖
        run: |
          if [ ! -f go.mod ]; then
            go mod init ${{ env.MODULE_NAME }}
          fi
          
          go get github.com/gorilla/websocket@latest
          go mod tidy

      - name: 构建二进制
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          binary_name="${{ env.BINARY_NAME }}"
          if [ "${{ matrix.os }}" = "windows" ]; then
            binary_name="${binary_name}.exe"
          fi
          
          # 构建时先不设置版本，在发布时再设置
          go build \
            -trimpath \
            -ldflags="-s -w" \
            -o "${binary_name}" \
            .
          
          mkdir -p dist
          package_name="${{ env.BINARY_NAME }}-${{ matrix.os }}-${{ matrix.arch }}"
          
          if [ "${{ matrix.os }}" = "windows" ]; then
            zip -9 "dist/${package_name}.zip" "${binary_name}" main.js demo.html
          else
            tar -czf "dist/${package_name}.tar.gz" "${binary_name}" main.js demo.html
          fi

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/
          retention-days: 1

################################################################################
# Docker 构建 (仅手动触发时执行)
################################################################################
  docker:
    name: Docker 构建
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: lint
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 QEMU
        uses: docker/setup-qemu-action@v3

      - name: 设置 Buildx
        uses: docker/setup-buildx-action@v3

      - name: 检查 Docker 环境变量
        run: |
          echo "DOCKER_USERNAME length: ${#DOCKER_USERNAME}"
          echo "DOCKER_USERNAME (masked): ${DOCKER_USERNAME:0:3}***"
          if [ -z "$DOCKER_USERNAME" ]; then
            echo "错误: DOCKER_USERNAME 未设置"
            exit 1
          fi
          if [ -z "$DOCKER_PASSWORD" ]; then
            echo "错误: DOCKER_PASSWORD 未设置"
            exit 1
          fi

      - name: 登录 Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: 构建并推送镜像 (Beta)
        if: ${{ github.event.inputs.release_type == 'Beta' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:beta
          build-args: GO_VERSION=${{ env.GO_VERSION }}

      - name: 构建并推送镜像 (Release)
        if: ${{ github.event.inputs.release_type == 'Release' }}
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: true
          tags: ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:latest
          build-args: GO_VERSION=${{ env.GO_VERSION }}

################################################################################
# 发布 (仅手动触发时执行)
################################################################################
  release:
    name: 发布
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    needs: [build, docker]
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 计算版本号并创建标签
        id: version
        run: |
          latest_tag=$(git tag -l "v*" --sort=-version:refname | head -n1 || echo "v0.0.0")
          
          if [[ $latest_tag =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            major=${BASH_REMATCH[1]}
            minor=${BASH_REMATCH[2]}
            patch=${BASH_REMATCH[3]}
          else
            major=0
            minor=0
            patch=0
          fi
          
          patch=$((patch + 1))
          new_version="v${major}.${minor}.${patch}"
          
          echo "version=$new_version" >> $GITHUB_OUTPUT
          echo "is_release=${{ github.event.inputs.release_type == 'Release' }}" >> $GITHUB_OUTPUT
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$new_version" -m "Release $new_version"
          git push origin "$new_version"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          path: artifacts
          merge-multiple: true

      - name: 重新打包并生成校验和
        run: |
          mkdir -p release
          
          # 重新打包所有文件，加上版本号
          for file in artifacts/*.zip artifacts/*.tar.gz; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              # 在文件名中插入版本号
              new_filename=$(echo "$filename" | sed "s/${{ env.BINARY_NAME }}-/${{ env.BINARY_NAME }}-${{ steps.version.outputs.version }}-/")
              cp "$file" "release/$new_filename"
            fi
          done
          
          # 生成校验和
          cd release
          sha256sum *.zip *.tar.gz > checksums.txt 2>/dev/null || sha256sum * > checksums.txt
          
          echo "发布文件列表:"
          ls -la
          echo
          echo "SHA256校验和:"
          cat checksums.txt

      - name: 更新 Docker 镜像标签
        run: |
          docker pull ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ github.event.inputs.release_type == 'Release' && 'latest' || 'beta' }}
          docker tag ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ github.event.inputs.release_type == 'Release' && 'latest' || 'beta' }} ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.version }}
          docker push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE }}:${{ steps.version.outputs.version }}

      - name: 生成发布说明
        run: |
          echo "**SHA256:**" > release_notes.md
          echo '```' >> release_notes.md
          cat release/checksums.txt >> release_notes.md
          echo '```' >> release_notes.md

      - name: 创建 Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.version.outputs.version }}
          name: "${{ steps.version.outputs.version }}"
          bodyFile: release_notes.md
          artifacts: "release/*"
          draft: false
          prerelease: ${{ steps.version.outputs.is_release != 'true' }}
          generateReleaseNotes: false
          allowUpdates: true
          removeArtifacts: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
